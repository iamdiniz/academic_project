{% extends 'base.html' %}
{% set hide_navbar = False %}

{% block title %}Detalhes do Aluno - Instituição{% endblock %}
{% block body %}
<div class="container mt-4">
    <h1 class="text-center mb-4">Detalhes do Aluno</h1>

    <form method="POST" onsubmit="return validateSkillsForm();" novalidate>
        <div class="mb-3">
            <label for="nome_jovem" class="form-label">Nome</label>
            <input type="text" class="form-control" id="nome_jovem" name="nome_jovem" value="{{ aluno.nome_jovem }}" required>
        </div>
        <div class="mb-3">
            <label for="data_nascimento" class="form-label">Data de Nascimento</label>
            <input type="date" class="form-control" id="data_nascimento" name="data_nascimento" value="{{ aluno.data_nascimento }}" required>
        </div>
        <div class="mb-3">
            <label for="contato_jovem" class="form-label">Contato</label>
            <input type="text" class="form-control" id="contato_jovem" name="contato_jovem" value="{{ aluno.contato_jovem }}">
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">E-mail</label>
            <input type="email" class="form-control" id="email" name="email" value="{{ aluno.email }}" required>
        </div>
        <div class="mb-3">
            <label for="endereco_jovem" class="form-label">Endereço</label>
            <input type="text" class="form-control" id="endereco_jovem" name="endereco_jovem" value="{{ aluno.endereco_jovem }}">
        </div>
        <div class="mb-3">
            <label>Curso</label>
            <select name="curso" id="cursoSelect" class="form-select" required>
                {% for curso in cursos_disponiveis %}
                    <option value="{{ curso }}" {% if aluno.curso == curso %}selected{% endif %}>{{ curso }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="formacao" class="form-label">Formação</label>
            <input type="text" class="form-control" id="formacao" name="formacao" value="{{ aluno.formacao }}">
        </div>
        <div class="mb-3">
            <label for="periodo" class="form-label">Período</label>
            <input type="number" class="form-control" id="periodo" name="periodo" value="{{ aluno.periodo }}">
        </div>

        <h4 class="mt-4">Hard Skills</h4>
        <div id="hardSkillsFields" class="row"></div>

        <h4 class="mt-4">Soft Skills</h4>
        <div class="row">
            {% for label in soft_labels %}
            <div class="col-md-6">
                <label>{{ label }}</label>
                <input type="number" class="form-control soft-skill-input" name="{{ label.lower().replace(' ', '_') }}"
                    value="{{ soft_dict[label] if soft_dict[label] is defined else 0 }}" min="0" max="10" step="1" required>
            </div>
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-primary mt-4">Salvar Alterações</button>
    </form>
</div>

<!-- Toasts de Notificação -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
  <div id="toastNotificacao" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastNotificacaoBody">
        <!-- Mensagem via JS -->
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                showToast({{ message|tojson }},
                    {% if category == 'success' %}'success'
                    {% elif category == 'warning' %}'warning'
                    {% elif category == 'danger' %}'danger'
                    {% else %}'info'{% endif %},
                    4000,
                    {% if category == 'success' %}'<i class="bi bi-check-circle-fill me-2"></i>'
                    {% elif category == 'warning' %}'<i class="bi bi-exclamation-triangle-fill me-2"></i>'
                    {% elif category == 'danger' %}'<i class="bi bi-x-circle-fill me-2"></i>'
                    {% else %}''{% endif %}
                );
            {% endfor %}
        {% endif %}
    {% endwith %}
});

const hardSkillsPorCurso = {{ HARD_SKILLS_POR_CURSO | tojson }};
const cursoSelect = document.getElementById('cursoSelect');
const hardSkillsFields = document.getElementById('hardSkillsFields');
const currentHardDict = {{ hard_dict|tojson }};

function renderHardSkillsFields() {
    const curso = cursoSelect.value;
    const hardSkills = hardSkillsPorCurso[curso] || [];
    hardSkillsFields.innerHTML = '';
    hardSkills.forEach(skill => {
        const fieldName = 'hard_' + skill.toLowerCase().replace(/ /g, '_');
        const value = currentHardDict[skill] !== undefined ? currentHardDict[skill] : '';
        hardSkillsFields.innerHTML += `
            <div class="col-md-6">
                <label>${skill}</label>
                <input name="${fieldName}" type="number" class="form-control hard-skill-input" min="0" max="10" step="1" required value="${value}">
            </div>
        `;
    });
}
cursoSelect.addEventListener('change', renderHardSkillsFields);
document.addEventListener('DOMContentLoaded', renderHardSkillsFields);

// Validação para não permitir campos vazios
function validateSkillsForm() {
    let valid = true;
    document.querySelectorAll('.hard-skill-input, .soft-skill-input').forEach(input => {
        if (input.value === '' || isNaN(input.value)) {
            input.classList.add('is-invalid');
            valid = false;
        } else {
            input.classList.remove('is-invalid');
        }
    });
    if (!valid) {
        alert('Preencha todos os campos de skills!');
    }
    return valid;
}

// Impede digitação de valores inválidos nos campos de skills
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('hard-skill-input') || e.target.classList.contains('soft-skill-input')) {
        let value = e.target.value.replace(/[^0-9]/g, '');
        if (value.length > 2) value = value.slice(0, 2);
        if (parseInt(value) > 10) value = '10';
        e.target.value = value;
    }
});

function showToast(message, type='danger', timeout=4000, icon='') {
    const toast = document.getElementById('toastNotificacao');
    const toastBody = document.getElementById('toastNotificacaoBody');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toastBody.innerHTML = icon + message;
    const bsToast = new bootstrap.Toast(toast, { delay: timeout });
    bsToast.show();
}

function validateSkillsForm() {
    let valid = true;
    let msg = '';

    // Nome
    const nome = document.getElementById('nome_jovem');
    if (!nome.value.trim()) {
        valid = false;
        msg += 'O campo Nome é obrigatório.\n';
        nome.classList.add('is-invalid');
        nome.focus();
    } else {
        nome.classList.remove('is-invalid');
    }

    // Data de nascimento
    const data = document.getElementById('data_nascimento');
    if (!data.value.trim()) {
        valid = false;
        msg += 'O campo Data de Nascimento é obrigatório.\n';
        data.classList.add('is-invalid');
        if (valid) data.focus();
    } else {
        data.classList.remove('is-invalid');
    }

    // Contato
    const contato = document.getElementById('contato_jovem');
    if (!contato.value.trim() || isNaN(contato.value) || contato.value.length < 8) {
        valid = false;
        msg += 'O campo Contato é obrigatório, apenas números e pelo menos 8 dígitos.\n';
        contato.classList.add('is-invalid');
        if (valid) contato.focus();
    } else {
        contato.classList.remove('is-invalid');
    }

    // Email
    const email = document.getElementById('email');
    if (!email.value.trim() || !email.value.includes('@') || !email.value.includes('.')) {
        valid = false;
        msg += 'O campo E-mail é obrigatório e deve ser válido.\n';
        email.classList.add('is-invalid');
        if (valid) email.focus();
    } else {
        email.classList.remove('is-invalid');
    }

    // Endereço
    const endereco = document.getElementById('endereco_jovem');
    if (!endereco.value.trim()) {
        valid = false;
        msg += 'O campo Endereço é obrigatório.\n';
        endereco.classList.add('is-invalid');
        if (valid) endereco.focus();
    } else {
        endereco.classList.remove('is-invalid');
    }

    // Formação
    const formacao = document.getElementById('formacao');
    if (!formacao.value.trim()) {
        valid = false;
        msg += 'O campo Formação é obrigatório.\n';
        formacao.classList.add('is-invalid');
        if (valid) formacao.focus();
    } else {
        formacao.classList.remove('is-invalid');
    }

    // Período
    const periodo = document.getElementById('periodo');
    if (
        !periodo.value.trim() ||
        isNaN(periodo.value) ||
        Number(periodo.value) < 1 ||
        Number(periodo.value) > 20 ||
        !Number.isInteger(Number(periodo.value))
    ) {
        valid = false;
        msg += 'O campo Período é obrigatório e deve ser um número inteiro entre 1 e 20.\n';
        periodo.classList.add('is-invalid');
        if (valid) periodo.focus();
    } else {
        periodo.classList.remove('is-invalid');
    }

    // Hard skills
    document.querySelectorAll('.hard-skill-input').forEach(input => {
        if (input.value === '' || isNaN(input.value) || input.value < 0 || input.value > 10) {
            input.classList.add('is-invalid');
            valid = false;
            msg += `Preencha corretamente a hard skill "${input.previousElementSibling.innerText}" (0 a 10).\n`;
        } else {
            input.classList.remove('is-invalid');
        }
    });

    // Soft skills
    document.querySelectorAll('.soft-skill-input').forEach(input => {
        if (input.value === '' || isNaN(input.value) || input.value < 0 || input.value > 10) {
            input.classList.add('is-invalid');
            valid = false;
            msg += `Preencha corretamente a soft skill "${input.previousElementSibling.innerText}" (0 a 10).\n`;
        } else {
            input.classList.remove('is-invalid');
        }
    });

    if (!valid) {
        showToast(msg, 'danger', 4000, '<i class="bi bi-x-circle-fill me-2"></i>');
    }
    return valid;
}

// Impede digitação de valores inválidos nos campos de skills e período
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('hard-skill-input') || e.target.classList.contains('soft-skill-input')) {
        let value = e.target.value.replace(/[^0-9]/g, '');
        if (value.length > 2) value = value.slice(0, 2);
        if (parseInt(value) > 10) value = '10';
        e.target.value = value;
    }
    if (e.target.id === 'periodo') {
        let value = e.target.value.replace(/[^0-9]/g, '');
        if (value.length > 2) value = value.slice(0, 2);
        if (value !== '') {
            let num = parseInt(value, 10);
            if (num < 1) num = 1;
            if (num > 20) num = 20;
            e.target.value = num;
        } else {
            e.target.value = '';
        }
    }
});
</script>
{% endblock %}