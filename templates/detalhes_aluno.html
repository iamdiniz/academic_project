{% extends 'base.html' %}
{% set hide_navbar = False %}

{% block title %}Detalhes do Aluno - {{ aluno.nome_jovem }}{% endblock %}

{% block body %}
<div class="container mt-4">
    <h2>Detalhes do Aluno</h2>
    <ul class="list-group">
        <li class="list-group-item"><strong>Nome:</strong> {{ aluno.nome_jovem }}</li>
        <li class="list-group-item"><strong>Data de Nascimento:</strong> {{ aluno.data_nascimento }}</li>
        <li class="list-group-item"><strong>Curso:</strong> {{ aluno.curso }}</li>
    </ul>

    <h4 class="mt-4">Skills</h4>
    {% if skills %}
        <canvas id="graficoSkills" width="400" height="200"></canvas>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            // Dados das skills
            const skillLabels = [
                "Hard Skills", "Soft Skills", "Avaliação Geral", "Participação",
                "Comunicação", "Proatividade", "Raciocínio", "Domínio Técnico",
                "Criatividade", "Trabalho em Equipe"
            ];
            const skillValues = [
                {{ skills["Hard Skills"]|default(0) }},
                {{ skills["Soft Skills"]|default(0) }},
                {{ skills["Avaliação Geral"]|default(0) }},
                {{ skills["Participação"]|default(0) }},
                {{ skills["Comunicação"]|default(0) }},
                {{ skills["Proatividade"]|default(0) }},
                {{ skills["Raciocínio"]|default(0) }},
                {{ skills["Domínio Técnico"]|default(0) }},
                {{ skills["Criatividade"]|default(0) }},
                {{ skills["Trabalho em Equipe"]|default(0) }}
            ];

            // Função para definir cor por valor
            function getBarColor(value) {
                if (value === 0) return 'rgba(0,0,0,0)';
                if (value <= 3) return 'rgba(220, 53, 69, 0.8)';      // Vermelho
                if (value <= 6) return 'rgba(255, 193, 7, 0.8)';      // Amarelo/laranja
                return 'rgba(40, 167, 69, 0.8)';                      // Verde
            }
            const barColors = skillValues.map(getBarColor);

            new Chart(document.getElementById('graficoSkills').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: skillLabels,
                    datasets: [{
                        label: 'Skills',
                        data: skillValues,
                        backgroundColor: barColors,
                        borderColor: barColors.map(c => c.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0,
                            max: 10,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        </script>
    {% else %}
        <p><em>Sem dados de skills disponíveis.</em></p>
    {% endif %}

    <div class="mt-4">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#contatoModal">Ver Contato</button>
        <button class="btn btn-warning" id="acompanharAlunoBtn">Acompanhar</button>
        <script>
        document.getElementById('acompanharAlunoBtn').onclick = function() {
            fetch('{{ url_for("acompanhar_aluno", id_aluno=aluno.id_aluno) }}', {
                method: 'POST'
            }).then(r => r.json()).then(data => {
                alert(data.message || data.error);
            });
        };
        </script>
        <a href="{{ previous_url }}" class="btn btn-secondary">Voltar</a>
    </div>
</div>

<!-- Modal (Pop-up) -->
<div class="modal fade" id="contatoModal" tabindex="-1" aria-labelledby="contatoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contatoModalLabel">Informações de Contato</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Contato:</strong> {{ aluno.contato_jovem }}</p>
                <p><strong>E-mail:</strong> {{ aluno.email }}</p>
                <p><strong>Endereço:</strong> {{ aluno.endereco_jovem }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                <button type="button" class="btn btn-success" id="indicarAlunoBtn">Indicar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Mensagem Customizada -->
<div class="modal fade" id="mensagemModal" tabindex="-1" aria-labelledby="mensagemModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mensagemModalLabel">Atenção</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body" id="mensagemModalBody">
        <!-- Mensagem será inserida via JS -->
      </div>
    </div>
  </div>
</div>

<script>
    // Função para exibir notificação ao indicar o aluno
    document.getElementById('indicarAlunoBtn').addEventListener('click', function () {
        fetch('{{ url_for("indicar_aluno", id_aluno=aluno.id_aluno) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id_aluno: {{ aluno.id_aluno }} })
        }).then(response => response.json())
          .then(data => {
              if (data.error) {
                  // Exibe mensagem de erro no modal customizado
                  document.getElementById('mensagemModalBody').textContent = data.error;
                  var mensagemModal = new bootstrap.Modal(document.getElementById('mensagemModal'));
                  mensagemModal.show();
              } else {
                  // Exibe mensagem de sucesso no modal customizado
                  document.getElementById('mensagemModalBody').textContent = data.message;
                  var mensagemModal = new bootstrap.Modal(document.getElementById('mensagemModal'));
                  mensagemModal.show();
                  // Fecha o modal de contato
                  const modal = bootstrap.Modal.getInstance(document.getElementById('contatoModal'));
                  modal.hide();
              }
          }).catch(error => {
              console.error('Erro ao indicar o aluno:', error);
              document.getElementById('mensagemModalBody').textContent = 'Ocorreu um erro ao tentar indicar o aluno.';
              var mensagemModal = new bootstrap.Modal(document.getElementById('mensagemModal'));
              mensagemModal.show();
          });
    });
</script>
{% endblock %}